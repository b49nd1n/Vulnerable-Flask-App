name: Docker Image CI

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

permissions:
  contents: read

jobs:

  semgrep:
    permissions:
      contents: read # for actions/checkout to fetch code
      security-events: write # for github/codeql-action/upload-sarif to upload SARIF results
      actions: read # only required for a private repository by github/codeql-action/upload-sarif to get the Action run status
    name: Scan
    runs-on: self-hosted
    steps:
      # Checkout project source
      - uses: actions/checkout@v4

      # Scan code using project's configuration on https://semgrep.dev/manage
      - name: scan code
        run: docker run -it -v "${PWD}:/src" --user=1000 semgrep/semgrep semgrep scan --sarif-output /src/result.sarif

      # Upload SARIF file generated in previous step
      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: result.sarif
        if: always()


  build:

    runs-on: self-hosted
    needs: semgrep
    steps:
    - uses: actions/checkout@v4
    - name: Build the Docker image
      run: docker build . --file Dockerfile --network=host --tag vuln-flask-app:latest

  run:
  
    runs-on: self-hosted
    needs: build

    steps:
    - name: run the service
      run: |
        docker rm -f vuln-flask-app
        docker run -d --name vuln-flask-app -p 8081:8081 vuln-flask-app:latest
